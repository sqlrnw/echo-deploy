name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

  workflow_dispatch:
    inputs:
      target:
        description: "Where to deploy"
        required: true
        type: choice
        options:
          - production

jobs:
  deploy_staging:
    name: Deploy to staging
    if: >
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Create deploy info
        run: |
          echo "env=staging" > deploy-stage-info.txt
          echo "secret_name_is_set=${{ secrets.SECRET_NAME != '' }}" >> deploy-stage-info.txt
          echo "commit=${{ github.event.workflow_run.head_sha }}" >> deploy-stage-info.txt

      - name: Upload deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-staging
          path: deploy-stage-info.txt

  deploy_production:
    name: Deploy to production
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Create deploy info
        run: |
          echo "env=production" > deploy-info.txt
          echo "secret_name_is_set=${{ secrets.SECRET_NAME != '' }}" >> deploy-info.txt
          echo "commit=${{ github.sha }}" >> deploy-info.txt

      - name: Upload deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-production
          path: deploy-info.txt

